# LeCoSAI

Lens correction software using astronomical images

天体の位置を用いたレンズ補正ソフト

# 概要
カメラのレンズ歪みを補正するプログラム

星空の映像を使用する。

カメラで撮影したレンズの効果で歪んだ星空の星の位置と、
星のカタログから参照した本来の位置を比較し、
レンズの歪みの行列を計算する。

# 実装した目的
カメラには、固有のゆがみがあり、
撮影した画像がゆがむ。
撮影画像からゆがみを取り除くには、カメラのパラメータを計算する必要がある。
チェッカーボード等により補正する方法が存在するが、
これにはカメラを自由に移動させる環境が必要となる。
しかし、流星等の観測用に既にカメラを設置してある場合、
それを取り外すのは手間である。
そこで、その状態で撮影可能な夜空の画像から
カメラのパラメータを計算可能とする本プログラムを実装した。

#検証環境
カメラ：ATOM Cam2

# 使用方法
LeCoSAIの使用方法を以下に記述する。
## 画像を用意
LeCoSAIに読み込ませる画像を用意する。

### 夜空を撮影
補正したいカメラで夜空を撮影する。
可能な限りに画像全体に星が写っているいることが望ましい。
また、補正時に使用するため撮影時刻を秒単位で記録しておくこと。

### マスクの作製
建物等の光度が高い物体が映り込むと星として検出してしまう。
それを防ぐために、マスクする領域を指定する画像を用いる。
マスク部分を白く塗りつぶした画像を使用する。
撮影範囲に光度が高い物体が存在しない場合、この手順はスキップしてよい。

## 初回処理手順
### LeCoSAIを起動する。
以下を実行することでLeCoSAIが起動する。
python3 LeCoSAI.py

初回起動時には、星空のカタログのダウンロード等が発生する。

### 画像の読み込み
撮影した星空の画像を読み込む。

Imageボタンを押し、撮影した星空の画像を選択する。
選択した星空の画像がメイン画面に表示される。
このとき、星として検出された領域が赤四角で囲まれて強調される。
画像から星の数は、Star領域のImageラベル下に表示される。

また、画像から星を抽出する際の閾値は、
Imageのスライドバーにより設定できる。
閾値が大きくなるほど、検出される星の数は少なくなる。

### マスクの読み込み
マスク画像を読み込む。

Maskボタンを押し、用意したマスク画像を選択する。
メイン画面がマスクされた状態で表示される。
撮影範囲に光度が高い物体が存在しない場合、この手順はスキップしてよい。

### 撮影日時の入力
撮影時刻を入力する。

入力日時は日本時間とし、
「年/月/日　時間：分：秒」の形式で入力する。

### 撮影場所の情報を入力
撮影場所の情報を入力する。

各ボックスに緯度(Lon)、経度(Lat)、標高(Hight)を入力する。
上下のボックスに仰角、左右のボックスに方位角を入力する。
方位角は、北を0度として、東を90度、南を180度、西を270度として記述する。
仰角は、水平を0度、垂直が90度とせして設定する。
方位と仰角に関しては、キーボード操作（ijkl）も活用する。
入力後、Inputボタンを押す。

撮影位置の情報は、Saveボタンを押すことで保存できる。
撮影位置が変更されなければ次回からは、Loadボタンで
保存した撮影位置の情報を読み込ませることが出来る。

### カタログの星の調整
Inputボタンを押すと、
カタログから作成した星がメイン画面に緑色の点として表示される。
この際、等級の高い星ほど点が大きく表示されている。
抽出されたカタログ星の数は、Star領域のCatalogに示されている。

表示する星の閾値は、
Catalogのスライドバーにより設定できる。
閾値が大きくなるほど、表示される星の数は少なくなる。

### 星の対応付け
手動でカタログの星の位置と画像内の星を対応付ける。

カタログの星（緑点）をクリックし、
次いで対応する画像内の星をクリックする。
対応付けられた星は、白線で結ばれる。

この対応付け作業を複数の星に対して行う。
このとき、対応付ける星が特定の場所に集中すると補正が失敗しやすい。
メイン画面内で可能な限り広範囲の星を対応付けるようにする。
対応付けられた星の数は、
Star領域のMap下に表示される。
20個以上の星を対応付けられたら、
次の工程に進む。

対応付けのTips
・代表的な星座を探すと星の対応が取りやすい。

・撮影した画像はカメラによりゆがんでおり、
カタログ内の星間の距離と角度が画像内の星と一致するとは限らないので注意すること。

・一度対応付けした星も、再度クリックすることで別の星と対応付けられる。

・Zoom領域にマウス周辺の拡大領域が出力される。
密集した星の区別に活用出来る。

・カタログの星は、以下のキーボード操作で移動させることが出来る。

i:上側へ移動

l:右へ移動

j:左側へ移動

k:下側へ移動

・Resetボタンを押すことで、
移動させたカタログの星を初期位置に戻せる。

###############対応付けを行った画像をここに入れること。

### カメラパラメータの計算
20個以上の対応付けしたら、Calibration領域のCalcボタンを押す。
カメラのパラメータが計算され、カタログの星が移動する。
カタログと星空の星の一致を確認する。
対応していない星が関連付けられていたら、修正する。

移動した星の位置を参考に、
星の対応付けを行う。

対応付けとカメラのパラメータを繰り返し
メイン領域全体でカタログと画像の星の位置がおおよそ一致したら
次の工程に進む。

### 星の自動対応
手動対応でおおよそ星の対応が取れたら、近接する星の対応を自動で取る。

Autoボタンを押すと、
カタログの星と近接する画像の星が自動的に対応付けられる。

Autoボタンを押した後に、
関連しない星が対応している場合は、その星の対応づけを解除する。

対応する星だけ関連付けられたら、
Calcボタンを押し、
最終的なカメラのパラメータを計算する。

このとき、星が全体的に正しく対応付けられているか確認すること。

### 計算したカメラパラメータの保存
算出したカメラのパラメータを保存する。

Saveボタンを押すことで計算したカメラのパラメータの保存先を指定する。
カメラを移動しない限りは、保存したパラメータを使用できる。

以上で、初期操作は完了。

## 保存情報を活用する。
初期操作で保存した各種設定情報を使用することで、
カメラパラメータの算出を迅速に行える。

同一のカメラを使用し、
おおよそ同一の画角が変化したような場合に行う操作。

### 画像とマスク取り込み、撮影日時の入力
初期操作と変更なし。

### 撮影位置の情報の読み込み
Location領域のLoadボタンを押し、
保存した場所の情報を読み込む。
その後、自動的にカタログの星が表示される。

### 計算したカメラパラメータの読み込み
Calibration領域のLoadボタンを押し、
保存したカメラパラメータの情報を読み込む。

### 星の移動
Calibration領域のMoveボタンを押し、
読み込んだカメラパラメータの情報に基づきカタログの星を移動させる。

### 星の対応を確認
星の対応を確認し、関連付けを適宜修正する。
クリックによる対応付けと、
Calcボタンを押した計算により
関連付けを完了する。

# カメラのパラメータについて
## パラメータの種類
## 内部パラメータについて
カメラ個体に依存するのパラメータ。同一個体においては、環境に依存しない。
fx
 fy,
cx,cy

dist
要確認：c1,c2を含まなければATOM Cam2は補正が困難だった。

## 外部パラメータについて
カメラの設置環境に依存する。カメラを固定している限りは、変化しない。
rvecs
tvecs
